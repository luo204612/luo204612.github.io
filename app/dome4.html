<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style type="text/css">
        .modelBox {
            width: 100%;
            height: 800px;
            margin: 0 auto;
            position: relative;
        }

        .btn {
            width: 100px;
            height: 50px;
            position: fixed;
            bottom: 50px;
            left: 50%;
            margin-left: -50px;
            background: chocolate;
            text-align: center;
            line-height: 50px;
            font-size: 25px;
            border-radius: 10%;
            display: none;
        }

        video {
            opacity: 0;
            height: 0;
        }

        .p5Canvas {
            display: block;
            margin: 0 auto !important;
            border: 1px solid black;
        }
    </style>
</head>



<body onload="init()">
    <video id="video1" autoplay loop muted>
        <source src="./static/粒子向左.mp4">
    </video>
    <video id="video2" autoplay loop muted>
        <source src="./static/粒子向右.mp4">
    </video>
    <video id="video3" autoplay loop muted>
        <source src="./static/时钟20s.mp4">
    </video>


    <div class="modelBox">
    </div>

    <script src="./js/three.js"></script>

    <!-- cdn 性能检测器 -->
    <script src="http://www.wjceo.com/lib/js/libs/stats.min.js"></script>
    <!-- cdn dat.GUI插件 -->
    <script src="https://cdn.bootcss.com/dat-gui/0.7.1/dat.gui.min.js"></script>
    <!-- TweenMax 插针动画插件 -->
    <script src="./js/TweenMax.min.js"> </script>
    <!-- 控制器引入 -->
    <script src="./controls/OrbitControls.js"></script>
    <!-- 引入格式Loader -->
    <script src="./loader/OBJLoader.js"></script>
    <script src="./loader/MTLLoader.js"></script>
    <script src="./loader/GLTFLoader.js"></script>


    <script>
        //声明一些全局变量
        var renderer, mycamera, scene, light, stats, spotLight
        var modelBox = document.getElementsByClassName("modelBox")[0]
        var btn = document.getElementsByClassName("btn")[0]
        console.log(modelBox.offsetWidth)
        //初始化渲染器
        function initRenderer() {
            renderer = new THREE.WebGLRenderer({ alpha: false, antialias: true, }); //实例化渲染器
            renderer.setSize(modelBox.clientWidth, modelBox.clientHeight); //设置宽和高
            renderer.shadowMap.enabled = true;//渲染阴影
            modelBox.appendChild(renderer.domElement); //添加到dom
        }

        //初始化场景
        function initScene() {
            scene = new THREE.Scene(); //实例化场景
        }

        //初始化相机
        function initmycamera() {
            mycamera = new THREE.PerspectiveCamera(45, modelBox.clientWidth / modelBox.clientHeight, 1, 1000); //实例化相机
            mycamera.position.set(0, 20, 120); //相机初始位置
            mycamera.lookAt(new THREE.Vector3(0, 0, 0)) //相机朝向
        }

        //创建灯光
        function initLight() {
            //添加一个全局环境光
            scene.add(new THREE.AmbientLight(0x222222, 1));
            // light = new THREE.PointLight(0xffffff, 0.5)
            // light.position.set(0, 20, 20)
            // scene.add(light)
            spotLight = new THREE.SpotLight(0xffffff); //创建一个白色光照

            spotLight.position.set(0, 15, 120)
            spotLight.intensity = 10; //修改光的强度
            spotLight.distance = 400; //修改光的照射范围
            spotLight.angle = 0.58; //修改光的照射弧度
            spotLight.penumbra = 1; //修改交界过渡
            spotLight.decay = 1; //修改衰减度
            // spotLight.target(new THREE.Vector3(0, 0, 150)) //相机朝向

            scene.add(spotLight);
            //添加灯光辅助

            spotLightHelper = new THREE.SpotLightHelper(spotLight);
            // scene.add(spotLightHelper);
        }


        //插件
        function initPlugin() {

        }

        //创建MTL加载器
        var mtlLoader = new THREE.MTLLoader();

        var objLoader = new THREE.OBJLoader();
        //设置当前加载的纹理
        // objLoader.setMaterials(material);
        objLoader.setPath('./obj/');
        objLoader.load('929-边.obj', function (object) {
            //添加阴影
            object.traverse(function (item) {
                if (item instanceof THREE.Mesh) {
                    item.castShadow = true;
                    item.receiveShadow = true;
                }
            });
            //缩放
            object.position.set(-32.5, -10.3, 1)
            object.scale.set(0.075, 0.075, 0.075);
            scene.add(object);
        })

        objLoader.load('929-体块.obj', function (object) {
            //添加阴影
            object.traverse(function (item) {
                if (item instanceof THREE.Mesh) {
                    item.castShadow = true;
                    item.receiveShadow = true;
                }
            });
            //缩放
            var material1 = new THREE.MeshLambertMaterial({ color: "black" })
            object.children[0].material = material1
            object.position.set(-32.5, -10.3, 1)
            object.scale.set(0.075, 0.075, 0.075);

            console.log(object.children)
            scene.add(object);
        })

        var wall1, wall2, wall3, wall4
        var leftMaterials = [];
        var rightMaterials = [];
        var midMaterials = [];

        for (let i = 0; i < 6; i++) {
            leftMaterials[i] = new THREE.MeshLambertMaterial({ color: 'grey' })
            rightMaterials[i] = new THREE.MeshLambertMaterial({ color: 'grey' })
            midMaterials[i] = new THREE.MeshLambertMaterial({ color: 'grey' })
        }
        //创建模型
        function initMesh() {


            var geometry = new THREE.BoxGeometry(65, 32, 2); //创建几何体

            var left = document.getElementById('video1');
            var leftTexture = new THREE.VideoTexture(left);
            leftMaterials[4].map = leftTexture
            var right = document.getElementById('video2');
            var rightTexture = new THREE.VideoTexture(right);
            rightMaterials[4].map = rightTexture

            var mid = document.getElementById('video3');
            var midTexture = new THREE.VideoTexture(mid);
            midMaterials[4].map = midTexture

            wall1 = new THREE.Mesh(geometry, new THREE.MeshFaceMaterial(leftMaterials)); //创建网格
            scene.add(wall1); //将网格添加到场景

            var geometry2 = new THREE.BoxGeometry(50, 32, 2); //创建几何体
            wall2 = new THREE.Mesh(geometry2, new THREE.MeshFaceMaterial(rightMaterials)); //创建网格
            scene.add(wall2); //将网格添加到场景
            wall2.position.set(-33.5, 0, 26)
            wall2.rotation.set(0, Math.PI / 2, 0)

            wall3 = new THREE.Mesh(geometry2, new THREE.MeshFaceMaterial(midMaterials)); //创建网格
            scene.add(wall3); //将网格添加到场景
            wall3.position.set(33.5, 0, 26)
            wall3.rotation.set(0, -Math.PI / 2, 0)

            var material = new THREE.MeshLambertMaterial({ color: "grey" }); //创建材质
            var floorGeometry = new THREE.BoxGeometry(100, 100, 1); //创建几何体
            wall4 = new THREE.Mesh(floorGeometry, material); //创建网格
            scene.add(wall4); //将网格添加到场景
            wall4.position.set(0, -17, 25)
            wall4.rotation.set(Math.PI / 2, 0, 0)
        }


        //创建控制器
        var controls;
        function initControls() {
            control = new THREE.OrbitControls(mycamera, renderer.domElement);
        }
        var mixer, clock = new THREE.Clock();
        function render() {
            control.update();
            var time = clock.getDelta();
            if (mixer) {
                mixer.update(time);
            }
            renderer.render(scene, mycamera);
        }

        // function onWindowResize() {
        //     mycamera.aspect = window.innerWidth / window.innerHeight;
        //     mycamera.updateProjectionMatrix();
        //     renderer.setSize(window.innerWidth, window.innerHeight);
        // }


        //运行动画
        function animate() {
            renderer.clear();


            render();
            requestAnimationFrame(animate); //循环调用函数

            // stats.update(); //更新性能插件
            // if (myObj)
            //更新光照辅助
            spotLightHelper.update();


            renderer.render(scene, mycamera); //渲染界面
        }

        function init() {
            initRenderer();
            initScene();
            initmycamera();
            initMesh();
            initLight();
            initPlugin()
            initControls();
            animate();
            // window.onresize = onWindowResize;
        }

    </script>

</body>

</html>